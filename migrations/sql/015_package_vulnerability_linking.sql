/*
Copyright (c) 2026 Oscar Valenzuela <oscar.valenzuela.b@gmail.com>
All Rights Reserved.

Migration 015: Package-Vulnerability Linking

This migration creates the infrastructure to link tracked packages to vulnerabilities:
- Junction table for package-vulnerability relationships
- GitHub URL column for enhanced matching
- View for vulnerability summaries per package

Part of Phase A: Package-Vulnerability Integration
GitHub Issue: #85
*/

-- Junction table: tracks which vulnerabilities affect which packages
CREATE TABLE IF NOT EXISTS tracked_package_vulnerabilities (
    id SERIAL PRIMARY KEY,
    package_id INTEGER NOT NULL REFERENCES tracked_packages(id) ON DELETE CASCADE,
    vulnerability_id INTEGER NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,

    -- Matching metadata
    matched_via TEXT NOT NULL,  -- 'purl_exact', 'purl_fuzzy', 'github_url', 'package_name'
    affects_current_version BOOLEAN DEFAULT TRUE,

    -- Discovery tracking
    discovered_at TIMESTAMP DEFAULT NOW(),
    last_checked_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(package_id, vulnerability_id)
);

-- Indexes for efficient queries
CREATE INDEX idx_pkg_vuln_package_id ON tracked_package_vulnerabilities(package_id);
CREATE INDEX idx_pkg_vuln_vulnerability_id ON tracked_package_vulnerabilities(vulnerability_id);
CREATE INDEX idx_pkg_vuln_discovered ON tracked_package_vulnerabilities(discovered_at DESC);
CREATE INDEX idx_pkg_vuln_affects_current ON tracked_package_vulnerabilities(affects_current_version);

-- Add GitHub URL to tracked_packages for matching (if not already present)
ALTER TABLE tracked_packages ADD COLUMN IF NOT EXISTS github_url TEXT;
CREATE INDEX IF NOT EXISTS idx_tracked_packages_github_url ON tracked_packages(github_url);

-- View: Package vulnerability summary
-- Aggregates vulnerability counts and severity information per package
CREATE OR REPLACE VIEW package_vulnerability_summary AS
SELECT
    p.id AS package_id,
    p.purl,
    p.name AS package_name,
    p.ecosystem,
    COUNT(v.id) AS total_vulnerabilities,
    COUNT(CASE WHEN v.severity = 'CRITICAL' THEN 1 END) AS critical_count,
    COUNT(CASE WHEN v.severity = 'HIGH' THEN 1 END) AS high_count,
    COUNT(CASE WHEN v.severity = 'MEDIUM' THEN 1 END) AS medium_count,
    COUNT(CASE WHEN v.severity = 'LOW' THEN 1 END) AS low_count,
    COUNT(CASE WHEN v.severity IN ('CRITICAL', 'HIGH') THEN 1 END) AS critical_high_count,
    MAX(v.cvss_score) AS max_cvss_score,
    AVG(v.cvss_score) AS avg_cvss_score,
    MAX(v.epss_score) AS max_epss_score,
    AVG(v.epss_score) AS avg_epss_score,
    array_agg(DISTINCT v.cve_id ORDER BY v.cve_id) FILTER (WHERE v.cve_id IS NOT NULL) AS cve_ids,
    MAX(tpv.discovered_at) AS last_vulnerability_discovered
FROM tracked_packages p
LEFT JOIN tracked_package_vulnerabilities tpv ON p.id = tpv.package_id
LEFT JOIN vulnerabilities v ON tpv.vulnerability_id = v.id
GROUP BY p.id, p.purl, p.name, p.ecosystem;

-- View: Recent vulnerability discoveries
-- Shows recently discovered vulnerabilities for tracked packages
CREATE OR REPLACE VIEW recent_package_vulnerabilities AS
SELECT
    tpv.id,
    tpv.package_id,
    p.name AS package_name,
    p.purl,
    p.ecosystem,
    tpv.vulnerability_id,
    v.vuln_id,
    v.cve_id,
    v.severity,
    v.cvss_score,
    v.epss_score,
    v.summary,
    tpv.matched_via,
    tpv.affects_current_version,
    tpv.discovered_at,
    v.published AS vuln_published_at
FROM tracked_package_vulnerabilities tpv
JOIN tracked_packages p ON tpv.package_id = p.id
JOIN vulnerabilities v ON tpv.vulnerability_id = v.id
ORDER BY tpv.discovered_at DESC;

-- Add comment for documentation
COMMENT ON TABLE tracked_package_vulnerabilities IS 'Links tracked packages to known vulnerabilities using multiple matching strategies';
COMMENT ON VIEW package_vulnerability_summary IS 'Aggregated vulnerability statistics per tracked package';
COMMENT ON VIEW recent_package_vulnerabilities IS 'Recent vulnerability discoveries for tracked packages, useful for monitoring';
